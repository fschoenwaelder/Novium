# Automation Framework

This add-on provides a framework that allows ZAP to be automated in an easy and flexible way.

### Command Line Options

It provides the following command line options:

- autorun <source> Run the automation jobs specified in the file or from the URL.
- autogenmin <filename> Generate template automation file with the key parameters.
- autogenmax <filename> Generate template automation file with all parameters.
- autogenconf <filename> Generate template automation file using the current configuration.

### Exit Codes

If the `-autorun` option is used with the ZAP `-cmd` option then the ZAP exit value will be set by default as follows:

- 0 - The plan completed successfully with no errors or warnings
- 1 - The plan reported one or more errors
- 2 - The plan reported no errors but one or more warnings

These values can be overridden by the [exitStatus](https://www.zaproxy.org/docs/desktop/addons/automation-framework/job-exitstatus/) job.

Whether the plan completed after encountering errors or warnings will depend on the settings used in the [environment](https://www.zaproxy.org/docs/desktop/addons/automation-framework/environment/).

### Usage

To use the automation framework:

1. Generate a template automation file using one of the `autogen*` command line options
2. Edit the file to match your requirements
3. Run the file using the `autorun` commandline option e.g. `./zap.sh -cmd -autorun config.yaml`

**Note:** The Jobs are executed in the order in which they appear (top to bottom) within the Plan.

In most cases it is recommended to also use the `-cmd` command line option so that the ZAP desktop is not displayed and ZAP exits as soon as it has finished generating or running the jobs defined in the file. However you can choose to run Automation Framework jobs using the ZAP desktop to help you debug issues.

## Authentication

The Automation Framework supports all of the [authentication](https://www.zaproxy.org/docs/desktop/addons/automation-framework/authentication/) mechanisms supported by ZAP.

## GUI

A [GUI](https://www.zaproxy.org/docs/desktop/addons/automation-framework/gui/) is under development and provides an ever increasing set of features.

## Options

The [Automation Options](https://www.zaproxy.org/docs/desktop/addons/automation-framework/options/) screen allows you to configure specific options.

## API

The following API endpoints are provided by this add-on:

- Action: runPlan(filePath) - loads and asynchronously runs the plan in the specified file, returning a planId
- View: planProgress(planId) - returns the progress details for the specified planId

If the ZAP desktop is being used then the plan will also be shown in the GUI to make it easier to diagnose any problems.

## Environment

The [environment](https://www.zaproxy.org/docs/desktop/addons/automation-framework/environment/) section of the file defines the applications which the rest of the jobs can act on.

## File Paths

All file and directory paths can either be absolute or relative to the directory containing the plan. Relative paths are recommended for portability.

## Jobs

The jobs can be enabled/disabled through the GUI and the automation plan, with the `enabled` flag. Jobs are enabled by default.

The following automation jobs are supported by this add-on:

- [activeScan-config](https://www.zaproxy.org/docs/desktop/addons/automation-framework/job-ascanconfig/) - configures the active scanner
- [activeScan-policy](https://www.zaproxy.org/docs/desktop/addons/automation-framework/job-ascanpolicy/) - creates an active policy
- [addOns](https://www.zaproxy.org/docs/desktop/addons/automation-framework/job-addons/) - add-on management, now deprecated
- [delay](https://www.zaproxy.org/docs/desktop/addons/automation-framework/job-delay/) - pauses the plan for a specified period of time or a specific condition is met
- [requestor](https://www.zaproxy.org/docs/desktop/addons/automation-framework/job-requestor/) - crafts specific requests to send to the corresponding targets
- [activeScan](https://www.zaproxy.org/docs/desktop/addons/automation-framework/job-ascan/) - runs the active scanner
- [exitStatus](https://www.zaproxy.org/docs/desktop/addons/automation-framework/job-exitstatus/) - sets ZAP’s exit code based on scan results

### Importance of Job Order

The order of jobs is relevant and important. For example:

- there is no point putting a passiveScan-wait job before any sort of spidering or importing
- configuring an alertFilter job after alerts have been generated by passive or active scanning will have no effect on the Alerts that were raised by those components in earlier jobs

[Job tests](https://www.zaproxy.org/docs/desktop/addons/automation-framework/tests/) can be added to jobs to check that the jobs have performed as expected.

This framework is plugable and so other add-ons may add support for other jobs, see the [Automation Framework](https://www.zaproxy.org/docs/automate/automation-framework/) website pages for a more complete list.

The ‘min’ and ‘max’ templates include comments giving more information about the fields.

# Automation Framework - authentication

The Automation Framework supports all of the authentication mechanisms supported by ZAP.

## Environmental Variables

ZAP supports a set of Authentication Header Environmental Variables - these will be applied by ZAP if they are defined however ZAP is run, including via the Automation Framework.

These environmental variables must be defined at the system level - if they are defined in the [environment](https://www.zaproxy.org/docs/desktop/addons/automation-framework/environment/) env section then they will be ignored.

## Context Based Authentication

The Automation Framework supports the following methods of authentication supported by ZAP:

- Manual (use this if you are using the Authentication Header Environmental Variable)
- HTTP / NTLM
- Form-based
- JSON-based
- Script

The Automation Framework supports the following methods of authentication provided by the Authentication Helper add-on:

- Auto-Detect Authentication
- Browser-based Authentication
- Client Script Authentication

## Authentication Statistics

ZAP maintains authentication statistics - search for ‘auth’ in the key field on the [ZAP Internal Statistics](https://www.zaproxy.org/docs/internal-statistics/) website page. These are ideal to use in [tests](https://www.zaproxy.org/docs/desktop/addons/automation-framework/tests/) to make sure the authentication is working as you expect.

The authentication statistics are maintained for all supported authentication methods (including ‘manual’) but only if you have configured all of the authentication elements correctly.

You are strongly advised to test this via the ZAP desktop GUI.

## Configuring Authentication

The recommended way to configure authentication is to do so via the ZAP desktop GUI - this gives you complete control over all aspects and allows you to test it in place.

Then you can create a new Automation Framework plan using the context(s) you have tested - the authentication elements will be correctly initialised for all aspects supported.

It is worth noting that the authentication elements cannot be edited via the Automation Framework [GUI](https://www.zaproxy.org/docs/desktop/addons/automation-framework/gui/), but they will not get lost if you use the GUI as long as you do not use it to delete the contexts.

The GUI will be updated to support all of the authentication elements in due course.

# Automation Framework - Environment

This section of the YAML configuration file defines the applications which the rest of the jobs can act on.

The environment is covered in the video: [ZAP Chat 08 Automation Framework Part 2 - Environment](https://youtu.be/1fcpU54N-mA).

The Automation Framework supports all of the [authentication](https://www.zaproxy.org/docs/desktop/addons/automation-framework/authentication/) mechanisms supported by ZAP.

**Note** When testing targets that operate on default ports (80 for http, 443 for https), the colon port portion of the URL should not be included. Including that portion (for example: [http://example.com:80](http://example.com/)) may result in an inability to crawl or test the target. If a ‘default’ port is specified both browsers and ZAP treat it without the default port being included then it doesn’t match the expectation within the Context and there’s nothing to interact with as part of the Context.

```yaml
env:                                   # The environment, mandatory
  contexts :                           # List of 1 or more contexts, mandatory
    - name: context 1                  # Name to be used to refer to this context in other jobs, mandatory
      urls:                            # A mandatory list of top level urls, everything under each url will be included
      includePaths:                    # An optional list of regexes to include
      excludePaths:                    # An optional list of regexes to exclude
      authentication:
        method:                        # String, one of 'manual', 'http', 'form', 'json', 'script', "autodetect", "browser", or "client"
        parameters:                    # May include any required for scripts. All of the parameters support vars except for the port
          hostname:                    # String, only for 'http' authentication
          port:                        # Int, only for 'http' authentication
          realm:                       # String, only for 'http' authentication
          loginPageUrl:                # String, the login page URL to read prior to making the request, only for 'form' or 'json' authentication
          loginRequestUrl:             # String, the login URL to request, only for 'form' or 'json' authentication
          loginRequestBody:            # String, the login request body - if not supplied a GET request will be used, only for 'form' or 'json' authentication
          script:                      # String, path to script, only for 'script' authentication
          scriptEngine:                # String, the name of the script engine to use, only for 'script' authentication
        verification:
          method:                      # String, one of 'response', 'request', 'both', 'poll'
          loggedInRegex:               # String, regex pattern for determining if logged in
          loggedOutRegex:              # String, regex pattern for determining if logged out
          pollFrequency:               # Int, the poll frequency, only for 'poll' verification
          pollUnits:                   # String, the poll units, one of 'requests', 'seconds', only for 'poll' verification
          pollUrl:                     # String, the URL to poll, only for 'poll' verification
          pollPostData:                # String, post dat to include in the poll, only for 'poll' verification
          pollAdditionalHeaders:       # List of additional headers for poll request, only for 'poll' verification
          - header:                    # The header name
            value:                     # The header value
      sessionManagement:
        method:                        # String, one of 'cookie', 'http', 'script'
        parameters:                    # List of 0 or more parameters - may include any required for scripts
          script:                      # String, path to script, only for 'script' session management
          scriptEngine:                # String, the name of the script engine to use, only for 'script' session management
      technology:
        exclude:                       # List of tech to exclude, as per https://www.zaproxy.org/techtags/ (just use last names)
        include:                       # List of tech to include, should only be used when targeting specific techs, the exclude takes precedence when configuring the context.
      structure:
        structuralParameters:          # List of names of structural parameters.
      users:                           # List of one or more users available to use for authentication
      - name:                          # String, the name to be used by the jobs
        credentials:                   # List of user credentials - may include any required for scripts
          username:                    # String, the username to use when authenticating, vars supported
          password:                    # String, the password to use when authenticating, vars supported
          totp:                        # The TOTP data, supported by Browser Based Authentication.
            secret:                    # String, the secret.
            period:                    # Int, the period. Default: 30
            digits:                    # Int, the number of digits. Default: 6
            algorithm:                 # String, the algorithm. Default: SHA1
  vars:                                # List of 0 or more custom variables to be used throughout the config file
    myVarOne: CustomConfigVarOne       # Can be used as ${myVarOne} anywhere throughout the config
    myVarTwo: ${myVarOne}.VarTwo       # Can refer other vars
  parameters:
    failOnError: true                  # If set exit on an error
    failOnWarning: false               # If set exit on a warning
    continueOnFailure: false           # Continue running all jobs, even if one fails
    progressToStdout: true             # If set will write job progress to stdout
  proxy:                               # Optional upstream proxy settings
    hostname:                          # String, the proxy host
    port:                              # Int, the proxy port
    realm:                             # String, the proxy realm
    username:                          # String, the proxy username
    password:                          # String, the proxy password

```

### Variables

Variables can be defined in the ‘vars’ section. They can be hardcoded, refer to other variables or refer to system environment variables in the same way as above, e.g. ‘${envvar}’. In case there are two variables with the same name, the value of the system variable would be preferred.

### Format Changes

Originally the ’engine’ and ‘scriptEngine’ fields were directly under the ‘sessionManagement’ element - this is still supported when reading plans but they will now always be output under the ‘parameters’ element.

Originally the ‘username’ and ‘password’ fields were directly under the user element - this is still supported when reading plans but they will now always be output under the ‘credentials’ element.

When specifying technology the tech names are given on [https://www.zaproxy.org/techtags/](https://www.zaproxy.org/techtags/) - only specify the last name, e.g. “C”.

# Automation Framework - GUI

The Automation Framework has a GUI that is in the process of being developed.

## Automation Tab

This tab allows you to create, load, edit and run automation jobs. It has 2 sub tabs.

A toolbar provides the following buttons:

- New Plan… - this launches the New Plan dialog
- Load Plan… - this allows you to load a plan from a yaml file
- Save Plan… - this saves the current plan to a yaml file
- Run Plan… - this runs the current plan
- Add Job… - this launches the Add Job dialog to add a job to the current plan
- Remove Job… - this removes the selected job from the current plan
- Move Job Up - this moves the selected job up one place in the current plan
- Move Job Down - this moves the selected job down one place in the current plan
- Add Test… - this launches the Add Test dialog to add a test to the current job
- Remove Test… - this removes the selected test from the current job

### Plan sub-tab

A graphical representation of the plan which also shows the state of the plan when it is run.

You can edit any of the elements of the plan by double clicking on them.

### Output sub-tab

Any output generated when you load or run the plan.

## Future Plans

Future versions of this add-on will add:

- Support for multiple plans
- Creating the plan from the current config

# Automation Framework - addOns Job

This job has been depreciated, no longer does anything, and should no longer be used.

Previously it allowed you to manage the ZAP add-ons. However it turns out that adding and updating add-ons when running a plan is a bad idea and does not work well.

For more details on how to manage add-ons see [https://www.zaproxy.org/docs/automate/automation-framework/#updating-add-ons](https://www.zaproxy.org/docs/automate/automation-framework/#updating-add-ons)

This job will be removed in the next major release of this add-on.

# Automation Framework - activeScan Job

This job runs the active scanner. This actively attacks your applications and should therefore only be used against applications that you have permission to test.

It is covered in the video: [ZAP Chat 12 Automation Framework Part 6 - Delays and Active Scan](https://youtu.be/hcftgjz_Vgc).

By default this job will actively scan the first context defined in the [environment](https://www.zaproxy.org/docs/desktop/addons/automation-framework/environment/) and so none of the parameters are mandatory.

This job supports [monitor](https://www.zaproxy.org/docs/desktop/addons/automation-framework/test-monitor/) tests.

## YAML

```yaml
  - type: activeScan                   # The active scanner - this actively attacks the target so should only be used with permission
    parameters:
      context:                         # String: Name of the context to attack, default: first context
      user:                            # String: An optional user to use for authentication, must be defined in the env
      policy:                          # String: Name of the scan policy to be used, default: Default Policy
      maxRuleDurationInMins:           # Int: The max time in minutes any individual rule will be allowed to run for, default: 0 unlimited
      maxScanDurationInMins:           # Int: The max time in minutes the active scanner will be allowed to run for, default: 0 unlimited
      addQueryParam:                   # Bool: If set will add an extra query parameter to requests that do not have one, default: false
      defaultPolicy:                   # String: The name of the default scan policy to use, default: Default Policy
      delayInMs:                       # Int: The delay in milliseconds between each request, use to reduce the strain on the target, default 0
      handleAntiCSRFTokens:            # Bool: If set then automatically handle anti CSRF tokens, default: false
      injectPluginIdInHeader:          # Bool: If set then the relevant rule Id will be injected into the X-ZAP-Scan-ID header of each request, default: false
      scanHeadersAllRequests:          # Bool: If set then the headers of requests that do not include any parameters will be scanned, default: false
      threadPerHost:                   # Int: The max number of threads per host, default: 2 * Number of available processor cores
      maxAlertsPerRule:                # Int: Maximum number of alerts to raise per rule, default: 0 unlimited
    policyDefinition:                  # The policy definition - only used if the 'policy' is not set
      defaultStrength:                 # String: The default Attack Strength for all rules, one of Low, Medium, High, Insane (not recommended), default: Medium
      defaultThreshold:                # String: The default Alert Threshold for all rules, one of Off, Low, Medium, High, default: Medium
      rules:                           # A list of one or more active scan rules and associated settings which override the defaults
      - id:                            # Int: The rule id as per https://www.zaproxy.org/docs/alerts/
        name:                          # String: The name of the rule for documentation purposes - this is not required or actually used
        strength:                      # String: The Attack Strength for this rule, one of Low, Medium, High, Insane, default: Medium
        threshold:                     # String: The Alert Threshold for this rule, one of Off, Low, Medium, High, default: Medium

```

**Note** : Unless the `defaultThreshold` of the `policyDefinition` is `OFF` all rules will be enabled to start with.

The policy can be one defined by a previous [activeScan-policy](https://www.zaproxy.org/docs/desktop/addons/automation-framework/job-ascanpolicy/) job, or by a scan policy file that has been put in `policies` directory under ZAP’s [HOME directory](https://www.zaproxy.org/faq/what-is-the-default-directory-that-zap-uses/) .

## Job Data

The following class will be made available to add-ons that provide access to the Job Data such as the Reporting add-on. Note that in this case the data is from the last Active Scan, regardless of whether it was started by the Automation Framework, the UI, or the API.

- Key: `activeScanData`
- Class: [ActiveScanJobResultData](https://github.com/zaproxy/zap-extensions/blob/main/addOns/automation/src/main/java/org/zaproxy/addon/automation/jobs/ActiveScanJobResultData.java)

# Automation Framework - activeScan-config Job

This job configures the active scanner, for custom active scans (e.g. Sequence).

## YAML

```yaml
  - type: activeScan-config                # Configures the settings of the active scanner.
    parameters:
      maxRuleDurationInMins:               # Int: The max time in minutes any individual rule will be allowed to run for, default: 0 unlimited
      maxScanDurationInMins:               # Int: The max time in minutes the active scanner will be allowed to run for, default: 0 unlimited
      maxAlertsPerRule:                    # Int: Maximum number of alerts to raise per rule, default: 0 unlimited
      defaultPolicy:                       # String: The name of the default scan policy to use, default: Default Policy
      handleAntiCSRFTokens:                # Bool: If set then automatically handle anti CSRF tokens, default: false
      injectPluginIdInHeader:              # Bool: If set then the relevant rule ID will be injected into the X-ZAP-Scan-ID header of each request, default: false
      threadPerHost:                       # Int: The max number of threads per host, default: 2 * Number of available processor cores
    inputVectors:                          # The input vectors used during the active scan.
      urlQueryStringAndDataDrivenNodes:    # Configures the scanning of query parameters and DDNs.
         enabled:                          # Bool: If query parameters and DDNs scanning should be enabled. Default: true
         addParam:                         # Bool: If a query parameter should be added if none present. Default: false
         odata:                            # Bool: If OData query filters should be scanned. Default: true
      postData:                            # Configures the scanning of request bodies.
        enabled:                           # Bool: If enabled. Default: true
        multiPartFormData:                 # Bool: If multipart form data bodies should be scanned. Default: true
        xml:                               # Bool: If XML bodies should be scanned. Default: true
        json:                              # Configures the scanning of JSON bodies.
          enabled:                         # Bool: If JSON scanning should be enabled. Default: true
          scanNullValues:                  # Bool: If null values should be scanned. Default: false
        googleWebToolkit:                  # Bool: If GWT scanning should be enabled. Default: false
        directWebRemoting:                 # Bool: If DWR scanning should be enabled. Default: false
      urlPath:                             # Bool: If URL path segments should be scanned. Default: false
      httpHeaders:                         # Configures the scanning of HTTP headers.
        enabled:                           # Bool: If HTTP header scanning should be enabled. Default: false
        allRequests:                       # Bool: If set then the headers of requests that do not include any parameters will be scanned. Default: false
      cookieData:                          # Configures the scanning of cookies.
        enabled:                           # Bool: If enabled. Default: false
        encodeCookieValues:                # Bool: If cookie values should be encoded. Default: false
      scripts:                             # Bool: If Input Vector scripts should be used. Default: true
```

# Automation Framework - activeScan-policy Job

This job defines an active scan policy. This policy can be used later in the plan by active scan related jobs, like [activeScan](https://www.zaproxy.org/docs/desktop/addons/automation-framework/job-ascan/) job.

## YAML

```yaml
  - type: activeScan-policy            # Defines a new active scan policy which can be used by later activeScan related jobs
    parameters:
      name:                            # String: Name of the policy, mandatory
    policyDefinition:                  # The policy definition
      defaultStrength:                 # String: The default Attack Strength for all rules, one of Low, Medium, High, Insane (not recommended), default: Medium
      defaultThreshold:                # String: The default Alert Threshold for all rules, one of Off, Low, Medium, High, default: Medium
      rules:                           # A list of one or more active scan rules and associated settings which override the defaults
      - id:                            # Int: The rule id as per https://www.zaproxy.org/docs/alerts/
        name:                          # Comment: The name of the rule for documentation purposes - this is not required or actually used
        strength:                      # String: The Attack Strength for this rule, one of Low, Medium, High, Insane, default: Medium
        threshold:                     # String: The Alert Threshold for this rule, one of Off, Low, Medium, High, default: Medium
```